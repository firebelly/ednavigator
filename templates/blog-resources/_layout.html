{% extends (craft.app.request.isAjax and not craft.app.request.isLivePreview) ? "_ajax-layout" : "_layout" %}

{% set limit = 10 %}
{% set query = craft.request.getParam('q') %}

{% if isEntry == true %}
  {% relatedSection = object.section ~ 'Entries' %}
  {% set params = { section: relatedSection, limit: limit} %}
{% else %}
  {% set params = { relatedTo: object, limit: limit } %}
{% endif %}

{% set title = object.title %}
{% set bodyClass = 'page page-' ~ object.slug %}

{% block content %}

  {% if not craft.app.request.isAjax %}

    <section class="intro-section">
      <div class="grid">

        <h2 class="page-description">
          {{ object.pageDescription }}
        </h2>

        {% if object.slug == 'blog' or object.section == 'blog' %}
        <div class="subscribe">
          <h4>Subscribe</h4>
          <p><a href="#" class="subscribe-link inline-link"><span>Get our blog posts delivered straight to your inbox.</span></a></p>
        </div>
        {% endif %}

      </div>
    </section>

    {% if object.slug == 'resources' || object.section == 'resources'  %}

    <div class="tools-and-bundles flex-grid">
      <div class="tool col-1-3">
        <h4>Tool</h4>
        <h3>Download <br>Our App</h3>
        <p><a href="#" class="inline-link"><span>Free educational resources on your mobile device</span></a></p>
      </div>

      {% set bundles = craft.categories.group('resourceBundle') %}
      {% for bundle in bundles %}
        <div class="bundle col-1-3">
          <div class="bundle-content">
            <h4>Resource Bundle</h4>
            <h3>{{ bundle.title }}</h3>
            <p><a href="{{ bundle.url }}" class="inline-link"><span>{{ bundle.pageDescription }}</span></a></p>
          </div>
          {% if bundle.bannerImage|length %}
        {% set bundleImage = bundle.bannerImage.one().getUrl() %}
        {% set bundleImageTransform = craft.imager.transformImage(bundleImage, { effects: { modulate: [100, 0, 100] } }) %}
            <div class="bundle-image" style="background-image:url({{ bundleImageTransform.url }})"></div>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    {% endif %}

    <div class="filter-section grid">


      <div class="search col-1-2">
        <form action="{{ url('blog/search') }}" class="search-filter">

          <div class="search-wrap">
            <input type="search" name="q" placeholder="Search Posts">
            <button type="submit" class="svg-inject" data-icon="icon-search"><span class="visually-hidden">Search Posts</span></button>
          </div>

        </form>

      </div>

      <div class="col-1-2 grid">

        <div class="filter category col-1-2">
          <div class="select-wrap">
            <select name="category" id="category">
              <option value="-1">Category</option>
              {% set relatedCategories = object.slug ~ 'Categories' %}
              {% for category in craft.categories.group(relatedCategories) %}
                <option value="{{ category.url }}">{{ category.title }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        {% set entries = craft.entries.section('blogEntries').limit(null) %}
        <div class="filter tag col-1-2">
          <div class="select-wrap">
            <select name="tag" id="tag">
              <option value="-1">Tag</option>
              {% for tag in craft.tags.relatedTo(entries) %}
                <option value="{{ tag.url }}">{{ tag.title }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

      </div>

    </div>


  {% endif %}

  {% paginate craft.entries(params) as pageInfo, articles %}

    {% if not craft.app.request.isAjax %}
    <div class="article-list">
    {% endif %}

      {% for article in articles %}
        {% include "blog/_article" %}
      {% endfor %}

    {% if not craft.app.request.isAjax and articles|length > limit %}
      </div>
      <div class="load-more-section">
        <button id="load-more" class="load-more" data-collection="blog" data-page="{{ pageInfo.currentPage + 1 }}" data-total-pages="{{ pageInfo.totalPages }}">Load More<span class="icon"><svg class="icon-arrow" role="img"><use xlink:href="#icon-arrow" /></span></button>
      </div>
    {% endif %}

  {% endpaginate %}

{% endblock %}